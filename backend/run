#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Backend development commands for cockpit-authelia-users.
#

set -o nounset
set -o pipefail
set -o errexit

# Change the current directory to the backend root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

################################################################################
# Helper Functions

function in_container {
  # Check if we're running inside a Docker container
  [[ -f /.dockerenv ]] || [[ -n "${DEVCONTAINER:-}" ]]
}

function run_uv {
  if in_container; then
    uv "$@"
  else
    # Run in Docker container
    docker compose -f ../docker/docker-compose.devtools.yml run --rm devtools \
      bash -c "cd /workspace/backend && uv $*"
  fi
}

################################################################################
# Development Commands

function test {
  #@ Run pytest tests
  #@ Category: Development
  run_uv run pytest "$@"
}

function lint {
  #@ Run ruff linter
  #@ Category: Development
  run_uv run ruff check .
}

function format {
  #@ Format code with ruff
  #@ Category: Development
  run_uv run ruff format .
}

function typecheck {
  #@ Run pyright type checker
  #@ Category: Development
  run_uv run pyright
}

function shell {
  #@ Open Python shell
  #@ Category: Development
  run_uv run python
}

function sync {
  #@ Sync dependencies with uv
  #@ Category: Development
  run_uv sync --all-extras
}

function clean {
  #@ Clean build artifacts
  #@ Category: Utility
  echo "Cleaning build artifacts..."
  rm -rf .pytest_cache .ruff_cache .coverage htmlcov __pycache__ .uv
  find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
  echo "Clean complete"
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "Backend Development Commands"
  echo "============================"
  echo ""
  echo "Available commands:"
  echo ""

  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-20s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
}

################################################################################
# Commands end.

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
